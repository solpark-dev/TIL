# [AWS] VPC 네트워크 환경 구축 및 EC2 배포 실습

## 1. 핵심 개념 정리 (On-Premise vs Cloud)

| 구분 | IDC (On-Premise) | AWS Cloud (VPC) |
| :--- | :--- | :--- |
| **인프라** | 물리적 데이터 센터 | **VPC** (Virtual Private Cloud) |
| **서버** | 물리 서버 (Rack) | **EC2** (가상 서버) |
| **네트워크 구획** | 스위치/라우터 분리 | **Subnet** (Public / Private) |
| **가용성(HA)** | 전원/건물 이중화 | **AZ** (Availability Zone, 가용 영역) |
| **방화벽** | 하드웨어 방화벽 | **Security Group** (인스턴스 단위), **NACL** (서브넷 단위) |

> **CIDR (Classless Inter-Domain Routing):** IP 주소를 유연하게 나누는 방식.
> * VPC 대역: `10.0.0.0/16` (65,536개 IP)
> * Subnet 대역: `10.0.0.0/24` (256개 IP)

---

## 2. 실습 아키텍처 설계

* **Region:** 서울 (ap-northeast-2)
* **VPC:** `test-vpc` (10.0.0.0/16)
* **구성:**
    1.  **Public Subnet (WAS)**: 외부 통신 가능 (IGW 연결)
    2.  **Private Subnet (DB)**: 외부 격리, 내부 통신만 허용 (NAT 연결 시 외부로 나가는 것만 가능)

### 네트워크 상세 정보
| 구분 | 리소스 이름 | CIDR / IP | 비고 |
| :--- | :--- | :--- | :--- |
| **VPC** | test-vpc | 10.0.0.0/16 | |
| **Subnet (Pub)** | test-subnet-was-pub-2a | 10.0.0.0/24 | WAS용, IGW 연결 |
| **Subnet (Pri)** | test-subnet-rdb-pri-2a | 10.0.2.0/24 | DB용, 외부 접근 불가 |
| **EC2 (Pub)** | test-was-pub-2a | 10.0.0.10 (사설) | Public IP 할당됨 |
| **EC2 (Pri)** | test-rdb-pri-2a | 10.0.2.10 (사설) | Public IP 없음 |

---

## 3. 구축 절차 (Step-by-Step)

### Step 1: 네트워크 뼈대 만들기
1.  **VPC 생성**: `test-vpc` (10.0.0.0/16)
2.  **서브넷 생성**:
    * Public: `10.0.0.0/24` (가용영역 2a)
    * Private: `10.0.2.0/24` (가용영역 2a)
3.  **인터넷 게이트웨이(IGW) 생성**: `test-igw` 생성 후 VPC에 연결.

### Step 2: 라우팅 테이블(Routing Table) 설정 **(중요)**
트래픽의 이정표를 설정하는 단계.

* **Public 라우팅 테이블 (`test-rt-pub-2a`)**
    * 연결: Public Subnet
    * 라우팅: `0.0.0.0/0` (모든 트래픽) → **IGW (인터넷 게이트웨이)**
* **Private 라우팅 테이블 (`test-rt-pri-2a`)**
    * 연결: Private Subnet
    * 라우팅: 초기 설정 없음 (VPC 내부 통신만 가능)

### Step 3: 보안 그룹(Security Group) 설정
* **WAS용 (Public)**: 포트 22(SSH), 80(HTTP), 443(HTTPS), ICMP 허용 (Source: Anywhere)
* **DB용 (Private)**: 포트 22(SSH), 3306(DB), ICMP 허용

### Step 4: EC2 인스턴스 생성 및 접속
1.  **WAS (Public) 생성**: 탄력적 IP(Elastic IP) 연결.
2.  **DB (Private) 생성**: Public IP 없음.
3.  **접속 테스트 (Bastion Host 개념)**:
    * Private DB는 외부에서 직접 접속 불가.
    * **로컬 PC → WAS(Public) → DB(Private)** 순서로 접속해야 함.

```bash
# 1. 키 파일 권한 변경 (필수)
chmod 400 251128-test.pem

# 2. WAS 접속
ssh -i "251128-test.pem" ubuntu@54.180.xxx.xxx

# 3. WAS에서 Private DB로 접속 (키 파일이 WAS에 있어야 함)
ssh -i "251128-test.pem" ubuntu@10.0.2.10

## 4. 확장 구성: NAT Gateway
**Private Subnet에 있는 서버가 업데이트 등을 위해 인터넷을 써야 한다면?**

1.  **NAT Gateway 생성**:
    * 반드시 **Public Subnet**에 생성해야 함.
    * 탄력적 IP 할당 필요.
2.  **Private 라우팅 테이블 수정**:
    * 대상: `0.0.0.0/0` → 타겟: **NAT Gateway**

> **결과:** Private DB에서 `ping google.com` 성공. (나갈 수는 있지만, 외부에서 들어올 수는 없음 = 보안 유지)

---

## 5. 리소스 정리 (삭제 순서)
과금 방지를 위해 **생성의 역순**으로 삭제.
1.  EC2 인스턴스 종료
2.  NAT Gateway 삭제 & 탄력적 IP 릴리즈
3.  VPC 라우팅 테이블 및 서브넷 삭제
4.  인터넷 게이트웨이 분리 및 삭제
5.  VPC 삭제

---

## 6. 더 알아보기 (ClickOps vs IaC)
* **ClickOps**: 콘솔에서 마우스로 클릭해서 만드는 방식 (현재 실습). 학습용으로 좋음.
* **IaC (Infrastructure as Code)**: 코드로 인프라를 생성/관리하는 방식. (Terraform, AWS CDK). 실무 권장.
